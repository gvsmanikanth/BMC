<sly data-sly-test.isEditing="${wcmmode.edit || wcmmode.design}"></sly>
<sly data-sly-test="${isEditing}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>
$(document).ready(function() {
	    $.ajax({
	        url: "/etc/reports/compreport/jcr:content/report.data.json"
	    }).then(function(data) {
		var jsondata = [];
		$(data.hits).each(function(index){
	    $(this.pagecol).each(function(){
	    jsondata[index] = {
	        comptypecol:data.hits[index].comptypecol,
	 		display:this.display,
			path:this.path+'.html',
	    };
		});
	    });
        $('button').click(function(){
        JSONToCSVConvertor(jsondata, "Report", true);
        });
        function JSONToCSVConvertor(JSONData, ReportTitle, ShowLabel) {
        //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
        var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;
        var CSV = '';    
        //This condition will generate the Label/Header
        if (ShowLabel) {
        var row = "";
        //Now convert each value to string and comma-seprated
         row ="comptypecol,display,path";
        //row = row.slice(0, -1);
        //append Label row with line break
        CSV += row + '\r\n';
        }
        //1st loop is to extract each row
        for (var i = 0; i < arrData.length; i++) {
          		 var row = "";
           		//2nd loop will extract each column and convert it in string comma-seprated
            	for (var index in arrData[i]) {
	            //console.log(arrData[i][index]);
	            row += '"' + arrData[i][index] + '",';
	            }
	            row.slice(0, row.length - 1);
	            //add a line break after each row
	            CSV += row + '\r\n';
	            }
	            CSV=CSV.replace(/<\/?[^>]+>/gi, '');
	            //alert(CSV);
                CSV = CSV.replace(/\*?[*]/gi,"");
                if (CSV == '') {        
                alert("Invalid data");
                return;
                }   
                //Generate a file name
                var fileName = "component_";
                //this will remove the blank-spaces from the title and replace it with an underscore
                fileName += ReportTitle.replace(/ /g,"_");   
                //Initialize file format you want csv or xls
                var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);
                // Now the little tricky part.
                // you can use either>> window.open(uri);
                // but this will not work in some browsers
                // or you will not get the correct file extension    
                //this trick will generate a temp <a />
                var link = document.createElement("a");    
                link.href = uri;
                //set the visibility hidden so it will not effect on your web-layout
                link.style = "visibility:hidden;";
                link.download = fileName + ".csv";
                //this part will append the anchor tag and remove it after automatic click
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                }
			});
		});
</script>
        <div>
        	<h1> Component Report </h1>
            <p class="greeting-id">The component report delivers information about how our website uses the components. </p>
            <p> Please check the report <a target="_blank" href="/etc/reports/compreport.html">here</a> before downloading the csv.</p>
            <p class="greeting-content">Using the Edit dialog the user can also set a Root path that defines the startpoint of the report - all components under that root are considered for the report.
			</p>
			<p> <b>For example</b>: If we want to find the list of pages which has htmlarea component, then add the path in <b>Component Type</b> -> Filter settings as "bmc/components/content/htmlarea" ->Apply.
        </div>
		  <div class='mydiv'>    
		   
		    <button class='gen_btn'>Download Csv</button>
		</div>	
</sly>
<sly data-sly-test="${!isEditing}"> <p>Please use author environment for component report <a href="https://author.cms.bmc.com/etc/reports/compreport.html">https://author.cms.bmc.com/etc/reports/compreport.html</a> </p></sly>
